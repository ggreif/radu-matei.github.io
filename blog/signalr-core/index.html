<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>Getting started with SignalR Alpha 2</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.52-DEV" />
        


        
            <meta name="author" content="Radu Matei">
        
        
            
                <meta name="description" content="Radu M - Kubernetes, containers and cloud native open-source developer tools. Debugging distributed systems. Software Engineer @Microsoft @Azure. Opinions are my own.">
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Getting started with SignalR Alpha 2"/>
<meta name="twitter:description" content="Table of Contents  Introduction Chat, of course Adding a C# console client Handling connection and disconnection events Working with an MVC/WebApi application Streaming Sending binary data Redis scaleout Conclusion  Introduction  ASP.NET SignalR is a library for ASP.NET developers that simplifies the process of adding real-time web functionality to applications. Real-time web functionality is the ability to have server code push content to connected clients instantly as it becomes available, rather than having the server wait for a client to request new data."/>
<meta name="twitter:site" content="@matei_radu"/>

        <meta property="og:title" content="Getting started with SignalR Alpha 2" />
<meta property="og:description" content="Table of Contents  Introduction Chat, of course Adding a C# console client Handling connection and disconnection events Working with an MVC/WebApi application Streaming Sending binary data Redis scaleout Conclusion  Introduction  ASP.NET SignalR is a library for ASP.NET developers that simplifies the process of adding real-time web functionality to applications. Real-time web functionality is the ability to have server code push content to connected clients instantly as it becomes available, rather than having the server wait for a client to request new data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radu-matei.com/blog/signalr-core/" /><meta property="article:published_time" content="2017-11-26T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2017-11-26T00:00:00&#43;00:00"/>

        
<meta itemprop="name" content="Getting started with SignalR Alpha 2">
<meta itemprop="description" content="Table of Contents  Introduction Chat, of course Adding a C# console client Handling connection and disconnection events Working with an MVC/WebApi application Streaming Sending binary data Redis scaleout Conclusion  Introduction  ASP.NET SignalR is a library for ASP.NET developers that simplifies the process of adding real-time web functionality to applications. Real-time web functionality is the ability to have server code push content to connected clients instantly as it becomes available, rather than having the server wait for a client to request new data.">


<meta itemprop="datePublished" content="2017-11-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-11-26T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2418">



<meta itemprop="keywords" content="" />

        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-81142224-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
    <h2><a href="/">Radu M</i></a></h2>
    

    <nav class="links">
        <ul>
            
            
            
            <li>
                <a href="/blog" >
                    
                    <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                </a>
            </li>
            
            
            
            <li>
                <a href="/about" >
                    
                    <i class="fa fa-smile-o">&nbsp;</i>About
                </a>
            </li>
            
            
            
            <li>
                <a href="/speaking" >
                    
                    <i class="fa fa-comments-o">&nbsp;</i>Speaking
                </a>
            </li>
            
            
            
            <li>
                <a href="/contact" >
                    
                    <i class="fa fa-envelope-o">&nbsp;</i>Contact
                </a>
            </li>
            
            
            
            <li>
                <a href="https://github.com/radu-matei"  target="_blank" >
                    
                    <i class="fa fa-github">&nbsp;</i>Open Source
                </a>
            </li>
            
            
            
            <li>
                <a href="https://twitter.com/matei_radu"  target="_blank" >
                    
                    <i class="fa fa-twitter">&nbsp;</i>Tweets
                </a>
            </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://radu-matei.com">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
    <section>
        <form class="search" method="get" action="//google.com/search">
            <input type="text" name="q" placeholder="Search" />
            <input type="hidden" name="q" value="site:https://radu-matei.com">
        </form>
    </section>

    
    <section>
        <ul class="links">
            
            
            
            <li>
                <a href="/blog" >
                    <h3>
                        
                        <i class="fa fa-newspaper-o">&nbsp;</i>
                        
                        Blog
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="/about" >
                    <h3>
                        
                        <i class="fa fa-smile-o">&nbsp;</i>
                        
                        About
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="/speaking" >
                    <h3>
                        
                        <i class="fa fa-comments-o">&nbsp;</i>
                        
                        Speaking
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="/contact" >
                    <h3>
                        
                        <i class="fa fa-envelope-o">&nbsp;</i>
                        
                        Contact
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="https://github.com/radu-matei"  target="_blank" >
                    <h3>
                        
                        <i class="fa fa-github">&nbsp;</i>
                        
                        Open Source
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="https://twitter.com/matei_radu"  target="_blank" >
                    <h3>
                        
                        <i class="fa fa-twitter">&nbsp;</i>
                        
                        Tweets
                    </h3>
                </a>
            </li>
            
        </ul>
    </section>

    
    <section>
        <ul class="links">
            <header>
                <h3>Recent Posts</h3>
            </header>
            
            
            

            
            <li>
                <a href="https://radu-matei.com/blog/filter-k8s-logs/">
                    <p>Filter secrets from Kubernetes logs</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/state-of-debugging-microservices-on-k8s/">
                    <p>The state of debugging microservices on Kubernetes</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/debug-helm-tiller/">
                    <p>Debug Helm and Tiller using VS Code and Draft</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/real-world-draft/">
                    <p>Using Draft to develop front-end &#43; back-end applications. Experimenting with Draft, VS Code and remote debugging.</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/kube-toolkit/">
                    <p>kube-toolkit: Toolkit for creating gRPC-based CLI tools for Kubernetes, written in Go</p>
                </a>
            </li>
            
        </ul>
    </section>

    
    
</section>
    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&text=Getting%20started%20with%20SignalR%20Alpha%202&via=matei_radu" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&title=Getting%20started%20with%20SignalR%20Alpha%202" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&title=Getting%20started%20with%20SignalR%20Alpha%202" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&title=Getting%20started%20with%20SignalR%20Alpha%202" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Radu%20Matei&body=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="https://radu-matei.com/blog/signalr-core/">Getting started with SignalR Alpha 2</a></h1>
            
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2017-11-26'>
            November 26, 2017</time>
        <span class="author">Radu Matei</span>
        
            <p>12 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&text=Getting%20started%20with%20SignalR%20Alpha%202&via=matei_radu" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&title=Getting%20started%20with%20SignalR%20Alpha%202" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&title=Getting%20started%20with%20SignalR%20Alpha%202" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f&title=Getting%20started%20with%20SignalR%20Alpha%202" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Radu%20Matei&body=https%3a%2f%2fradu-matei.com%2fblog%2fsignalr-core%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    

    <div id="content">
        

<h2 id="table-of-contents">Table of Contents</h2>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#chat-of-course">Chat, of course</a></li>
<li><a href="#adding-a-c-console-client">Adding a C# console client</a></li>
<li><a href="#handling-connection-and-disconnection-events">Handling connection and disconnection events</a></li>
<li><a href="#working-with-an-mvc-webapi-application">Working with an MVC/WebApi application</a></li>
<li><a href="#streaming">Streaming</a></li>
<li><a href="#sending-binary-data">Sending binary data</a></li>
<li><a href="#redis-scaleout">Redis scaleout</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<blockquote>
<p>ASP.NET SignalR is a library for ASP.NET developers that simplifies the process of adding real-time web functionality to applications. Real-time web functionality is the ability to have server code push content to connected clients instantly as it becomes available, rather than having the server wait for a client to request new data.</p>

<p>You can <a href="https://github.com/aspnet/signalr" target="_blank">follow the development of SignalR on GitHub</a></p>
</blockquote>

<p>While ASP.NET hit version 2.0, SignalR has been in development for the better part of the last couple if years - and if you want to get an insight on new things, <a href="https://vimeo.com/204078084" target="_blank">I recommend watching this talk by David Fowler and Damian Edwards, the people in charge of SignalR (and the creators of it)</a>.</p>

<p>In this article we will explore how to get started with the Alpha 2 version of SignalR for ASP.NET Core 2.0 - you can <a href="https://blogs.msdn.microsoft.com/webdev/2017/10/09/announcing-signalr-for-asp-net-core-alpha-2/" target="_blank">read the announcement blog post on MSDN</a>, but here are some of the of the news in case you haven&rsquo;t followed SignalR for a while:</p>

<ul>
<li>new JavaScript and TypeScript clients</li>
<li>JSON and binary messages based on <a href="https://msgpack.org/" target="_blank">MessagePack</a> - and while <a href="https://github.com/aspnet/SignalR/blob/dev/specs/HubProtocol.md#protocol-buffers-protobuf-encoding" target="_blank">ProtoBuf is not yet implemented</a>, there are some <a href="- https://github.com/aspnet/SignalR/blob/357f5f85bbc7b794f95bcb63799f98bc1dcee68e/samples/SocialWeather/Protobuf/WeatherReport.proto" target="_blank">samples available</a> and I hope it will be one of the officially supported protocols</li>
<li>streaming support (this is incredibly exciting!)</li>
<li>no more automatic reconnection</li>
<li>single hub per connection</li>
</ul>

<p>In this blog post we will explore how to get started with some of the most common scenarios for SignalR, and in order to follow along you need version 2.0.0 of .NET Core installed on your machine - <a href="https://www.microsoft.com/net/download/" target="_blank">you can get started here</a></p>

<h2 id="chat-of-course">Chat, of course</h2>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/simple-chat" target="_blank">find the chat sample on GitHub</a></p>
</blockquote>

<p>Every article, talk or piece of documentation on SignalR needs to include a chat sample - this has been the standard ever since the beginning, and I will also include a sample here - it will be a very simple sample, just enough to make sure you have everything configured correctly and to understand the basic concepts of SignalR.</p>

<p>As I was saying earlier, you need .NET Core 2.0.0 in order to get started - we will create a new empty web application with <code>dotnet new web</code>, which gives us the simplest ASP.NET Core web application possible - a <code>Program.cs</code>, a  <code>Startup.cs</code> and a <code>.csproj</code>.</p>

<p>First, we need to add a reference to SignalR in our <code>.csproj</code> file - <code>&lt;PackageReference Include=&quot;Microsoft.AspNetCore.SignalR&quot; Version=&quot;1.0.0-alpha2-final&quot; /&gt;</code>, then do a <code>dotnet restore</code>.</p>

<p>This is how your <code>.csproj</code> should look like:</p>

<script type="application/javascript" src="//gist.github.com/radu-matei/6446f5d4b4c7076d76e3e50622d7a00d.js"></script>

<p>Now let&rsquo;s create our Chat Hub - essentially, it is a class that inherits the base <code>Hub</code> class from SignalR. It only has a single method, <code>Send</code>, which sends messages to all connected clients - in fact, the method tells all clients to execute their <code>broadcastMessage</code> with <code>name</code> and <code>message</code> as parameters.</p>

<script type="application/javascript" src="//gist.github.com/radu-matei/5d28200e30e0bf9af6f755bc85625884.js"></script>

<p>Now we need to tell our app to add the SignalR service and instruct it on how to expose the chat service we just created: all you need to notice here:</p>

<ul>
<li><code>services.AddSignalR()</code> - this adds SignalR to the available services and to the dependency injection engine</li>
<li><code>app.UseFileServer()</code> - this allows the serving of static files - we will need this once we add a simple HTML page</li>
</ul>

<pre><code class="language-csharp">app.UseSignalR(routes =&gt;
{
    routes.MapHub&lt;ChatHub&gt;(&quot;chat&quot;);
});
</code></pre>

<ul>
<li>this instructs the app to use SignalR and to map the Hub we just created, and expose the endpoint as <code>/chat</code></li>
</ul>

<p>Below is the full <code>Startup.cs</code> file:</p>

<script type="application/javascript" src="//gist.github.com/radu-matei/e1e41940adc28bbe002feefde96cacef.js"></script>

<p>Now to the client: we need to create a simple HTML page that can send messages. It will use the SignalR JavaScript client, which you can either download using <code>npm</code>: <code>npm install @aspnet/signalr-client</code>, or <a href="https://gist.github.com/radu-matei/84f12b835fbd0fbe3cbe165a70e13e34" target="_blank">use the gist from here</a>.</p>

<p>Here&rsquo;s a breakdown on what&rsquo;s happening in the web page:</p>

<ul>
<li>we have some input of type text, where we write the messages</li>
<li>we have a button that when we press we want to send the message</li>
<li>then we make a reference to the SignalR JavaScript client that should be in the same folder as your HTML file</li>
</ul>

<p>Now for the SignalR magic:</p>

<ul>
<li><code>var transport = signalR.TransportType.WebSockets;</code> - we specify that we want to use WebSockets</li>
<li><code>var connection = new signalR.HubConnection(&quot;http://${document.location.host}/chat&quot;, { transport: transport });</code> - we create a new SignalR connection to the <code>/chat</code> endpoint we defined in <code>Startup.cs</code>, using WebSockets as the trasport</li>
</ul>

<pre><code class="language-javascript">connection.on('broadcastMessage', (name, message) =&gt; {
    var liElement = document.createElement('li');
    liElement.innerHTML = '&lt;strong&gt;' + name + '&lt;/strong&gt;:&amp;nbsp;&amp;nbsp;' + message;
    document.getElementById('discussion').appendChild(liElement);
});
</code></pre>

<ul>
<li>here we define and implement the <code>broadcastMessage</code> method we saw in the hub earlier - essentially, we add the message we received in an unordered list in the page</li>
</ul>

<pre><code class="language-javascript">button.addEventListener(&quot;click&quot;, event =&gt; {
    connection.invoke('send', name, messageInput.value);
    messageInput.value = '';
    messageInput.focus();
});
</code></pre>

<ul>
<li>then we simply start the connection: <code>connection.start();</code></li>
</ul>

<p>Below is the full <code>index.html</code>:</p>

<script type="application/javascript" src="//gist.github.com/radu-matei/015f4bcb856659d33484adf030bde50a.js"></script>

<p>Now if we want to actually see if it works, we need to start the web app (either from Visual Studio/Code, or through <code>dotnet run</code>), then in a browser go to <code>http://localhost:5000</code>:</p>

<p><img src="/img/article-photos/signalr/gif1.gif" alt="" /></p>

<p>At this point, you successfully created a very simple SignalR chat application - you now know how to create hub methods and client methods, and how to connect a web app using the JavaScript client.</p>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/simple-chat" target="_blank">find the chat sample on GitHub</a></p>
</blockquote>

<h2 id="adding-a-c-console-client">Adding a C# console client</h2>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/console-client" target="_blank">find the full implementation of the console client on GitHub</a></p>
</blockquote>

<p>Now if we want to connect a C#-based client, we only need to add the <code>Microsoft.AspNetCore.SignalR.Client</code> package to a <code>dotnet new console</code> newly created app, specifically <code>&lt;PackageReference Include=&quot;Microsoft.AspNetCore.SignalR.Client&quot; Version=&quot;1.0.0-alpha2-final&quot; /&gt;</code></p>

<p>Let&rsquo;s explore the most important things about the console client:</p>

<ul>
<li>we first start the connection to <code>http://localhost:5000/chat</code></li>
</ul>

<pre><code class="language-csharp">public static async Task StartConnectionAsync()
{
    _connection = new HubConnectionBuilder()
         .WithUrl(&quot;http://localhost:5000/chat&quot;)
         .WithConsoleLogger()
         .Build();

    await _connection.StartAsync();
}
</code></pre>

<ul>
<li>then, we register and implement the method for <code>broadcastMessage</code>:</li>
</ul>

<pre><code class="language-csharp">_connection.On&lt;string, string&gt;(&quot;broadcastMessage&quot;, (name, message) =&gt;
{
    Console.WriteLine($&quot;{name} said: {message}&quot;);
});
</code></pre>

<p>Below is the full <code>Program.cs</code>:</p>

<script type="application/javascript" src="//gist.github.com/radu-matei/068b6615beab5d1fdd251d0b56427c79.js"></script>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/console-client" target="_blank">find the full implementation of the console client on GitHub</a></p>
</blockquote>

<p>Let&rsquo;s see how it works:</p>

<p><img src="/img/article-photos/signalr/gif2.gif" alt="" /></p>

<h2 id="handling-connection-and-disconnection-events">Handling connection and disconnection events</h2>

<p>Another thing we used to do in the old SignalR was to handle connection and disconnection events through some overridden methods in our hubs. We can still do this in an extremely similar way - below you can find the <code>OnConnectedAsync</code> and <code>OnDisconnectedAsync</code> methods:</p>

<pre><code class="language-csharp">public override Task OnConnectedAsync()
{
    Clients.All.InvokeAsync(&quot;broadcastMessage&quot;, &quot;system&quot;, $&quot;{Context.ConnectionId} joined the conversation&quot;);
    return base.OnConnectedAsync();
}
</code></pre>

<ul>
<li><p>this method invokes the <code>broadcastMessage</code> and tells everybody the connection ID of the newly connected client, then returns and continues with the regular <code>OnConnectedAsync</code> implementation from the hub</p></li>

<li><p>the <code>OnDisconnectedAsync</code> method basically does the same thing</p>

<pre><code>public override Task OnDisconnectedAsync(System.Exception exception)
{
Clients.All.InvokeAsync(&quot;broadcastMessage&quot;, &quot;system&quot;, $&quot;{Context.ConnectionId} left the conversation&quot;);
return base.OnDisconnectedAsync(exception);
}
</code></pre></li>
</ul>

<h2 id="working-with-an-mvc-webapi-application">Working with an MVC/WebApi application</h2>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/signalr-mvc" target="_blank">find the MVC sample on GitHub</a></p>
</blockquote>

<p>Another popular situation of using SignalR is to provide notifications through an MVC or WebAPI application, more specifically through a controller method. This means the initial point of interaction will not by directly calling a hub method, but after one client making a REST request to a controller - then, from the controller method, we need to send an update to all connected clients.</p>

<p>We will start with a simple <code>dotnet new webapi</code> application and add SignalR the same way as we did earlier. Then, we will work with the <code>ValuesController</code> aleady generated for us.</p>

<p>Now we add a simple <code>NotificationsHub</code> that doesn&rsquo;t have any methods - since clients will not call directly hub methods, but rather be notified from the controller.</p>

<script type="application/javascript" src="//gist.github.com/radu-matei/4df09d4a3b955e697ef64bb7fba06382.js"></script>

<p>Now the client is pretty much the same, the only difference is that when the button is pressed, there is no SignalR hub invocation, but a simple fetch to a controller method - and the controller is the interesting one:</p>

<ul>
<li><p>in the constructor of the controller we inject an instance of the hub context for <code>NotificationsHub</code> - this will allow us to have a way to interact with the clients connected to <code>NotificationsHub</code> from outside the hub (remember <code>GlobalHost</code> in older versions of SignalR?)</p></li>

<li><p>then, we simply call some method on the connected clients as if we were inside a hub</p></li>
</ul>

<script type="application/javascript" src="//gist.github.com/radu-matei/7a01ffe6982324ea703efeeac128bac3.js"></script>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/signalr-mvc" target="_blank">find the MVC sample on GitHub</a></p>
</blockquote>

<ul>
<li>basically, whenever you need a hub context in ASP.NET Core outside of a hub, you can request an instance of the hub context from the dependency injection engine, and the framework will take care of it.</li>
</ul>

<p>So far we saw how to create a chat application with web and console clients, then how to send notifications from a controller. Let&rsquo;s now see how to stream data!</p>

<h2 id="streaming">Streaming</h2>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/streaming" target="_blank">find the streaming sample on GitHub</a></p>

<p>To get up to date with the observable pattern, you can <a href="https://docs.microsoft.com/en-us/dotnet/standard/events/observer-design-pattern" target="_blank">read this article from the docs</a></p>

<p>We will not get into details on how the streaming actually works, you can <a href="https://github.com/aspnet/SignalR/blob/dev/specs/HubProtocol.md#streaming" target="_blank">read the specification int the SignalR repo</a></p>
</blockquote>

<p>We will start again from a <code>dotnet new web</code> empty application and add SignalR as in the first example and add a <code>StreamingHub</code> class, and we will add a new streaming method in our hub. Let&rsquo;s see what&rsquo;s happening here:</p>

<ul>
<li>in order to stream from the method, we need it to return an <code>IObservable&lt;T&gt;</code> which will send a message every second</li>
<li>the <code>SendStreamInit</code> method is used to broadcast to all connected clients that the streaming started, and each client will handle the stream event in their specific way - we&rsquo;ll see more when implementing the clients</li>
</ul>

<pre><code class="language-csharp">public void SendStreamInit()
{
    Clients.All.InvokeAsync(&quot;streamStarted&quot;);
}

public IObservable&lt;string&gt; StartStreaming()
{
    return Observable.Create(
        async (IObserver&lt;string&gt; observer) =&gt;
        {
            for (int i = 0; i &lt; 10; i++)
            {
                observer.OnNext($&quot;sending...{i}&quot;);
                await Task.Delay(1000);
            }
        });
    }
}
</code></pre>

<p>Now for the JavaScript client:</p>

<ul>
<li>we define what should happen on the next streaming invocation - <code>next</code>, on error - <code>err</code> and when the streaming finishes - <code>complete</code></li>
<li>we add an event listener for the button which invokes the hub method that starts the streaming on all clients</li>
<li>then, we define and implement the <code>onStreamReceived</code> method which just adds the message to an unordered list</li>
</ul>

<p>The thing to notice here is that when one client pushes the stream button, all connected clients will start the streaming - you can directly call the streaming when the button is pressed if you only want the caller to start the streaming.</p>

<pre><code class="language-javascript">function startStreaming(){
    connection.stream(&quot;StartStreaming&quot;).subscribe({
        next: onStreamReceived,
        err: function(err){
            console.log(err);
        },
        complete: function(){
            console.log(&quot;finished streaming&quot;);
        }
    });
}

connection.on(&quot;streamStarted&quot;, function(){
    startStreaming();
});

button.addEventListener(&quot;click&quot;, event =&gt; {
    connection.invoke(&quot;sendStreamInit&quot;);
});

function onStreamReceived(data){
    console.log(&quot;received: &quot; + data);
    var liElement = document.createElement('li');
    liElement.innerHTML = '&lt;strong&gt;' + &quot;received&quot; + '&lt;/strong&gt;:&amp;nbsp;&amp;nbsp;' + data;
    document.getElementById('discussion').appendChild(liElement);
}
</code></pre>

<p>Now let&rsquo;s see a C# client handling the stream:</p>

<ul>
<li>here we see the most interesting part of the C# client, the part where we actually handle the streaming data - we start the streaming just like we did with the JavaScript client, then we try to read a <code>string</code> out of the channel - then, we simple print the message on the console.</li>
</ul>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/streaming" target="_blank">find the streaming sample on GitHub</a></p>
</blockquote>

<pre><code class="language-csharp">public async static Task StartStreaming()
{
    var channel = await _connection.StreamAsync&lt;string&gt;(&quot;StartStreaming&quot;, CancellationToken.None);
    while (await channel.WaitToReadAsync())
    {
        while (channel.TryRead(out string message))
        {
            Console.WriteLine($&quot;Message received: {message}&quot;);
        }
    }   
}
</code></pre>

<p>Now let&rsquo;s take a look at both the web and the C# clients running:</p>

<p><img src="/img/article-photos/signalr/gif3.gif" alt="" /></p>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/streaming" target="_blank">find the streaming sample on GitHub</a></p>
</blockquote>

<h2 id="sending-binary-data">Sending binary data</h2>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/binary" target="_blank">find the sample for the binary protocol on GitHub</a></p>
</blockquote>

<p>So far we only saw how to use the JSON protocol to send data. One of the awesome features of the new SignalR version is the ability to send binary encoded data. We will explore how to set the clients to use the binary format protocols.</p>

<p>First, the C# client - when defining the connection, all we need to to is tell <code>HubConnectionBuilder</code> to use the message pack protocol - here&rsquo;s how the connection initialization looks like:</p>

<pre><code class="language-csharp">public static async Task StartConnectionAsync()
{
    _connection = new HubConnectionBuilder()
         .WithUrl(&quot;http://localhost:5000/chat&quot;)
         .WithConsoleLogger()
         .WithMessagePackProtocol()
         .Build();

    await _connection.StartAsync();
}
</code></pre>

<p>The only difference is <code>.WithMessagePackProtocol()</code> - from this point on, the C# client will use the message pack protocol.</p>

<p>Now let&rsquo;s see the JavaScript client - here we also need to include the script for message pack: <code>signalr-msgpackprotocol-1.0.0-alpha2-final.js</code> (that you can get by doing <code>npm install @aspnet/signalr-client</code>), then define the protocol as being: <code>var protocol = new signalRMsgPack.MessagePackHubProtocol();</code></p>

<pre><code class="language-javascript">var protocol = new signalRMsgPack.MessagePackHubProtocol();
var connection = new signalR.HubConnection(`http://${document.location.host}/chat`, { transport: transport, protocol: protocol });
</code></pre>

<p>And that&rsquo;s pretty much it - you can <a href="https://github.com/radu-matei/signalr-samples/tree/master/binary" target="_blank">find a full example for the chat app and console client that use the binary protocol on GitHub</a>.</p>

<p>If we run the binary samples, we can see that the protocol is set in both cases to <code>messsagepack</code>.</p>

<p><img src="/img/article-photos/signalr/gif4.gif" alt="" /></p>

<p>So far we saw how to create a simple chat, to inject the hub context into a controller, stream data for JavaScript and C# clients and set the protocol to binary. Now we&rsquo;ll take a look at another common use case - Redis scaleout.</p>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/binary" target="_blank">find the sample for the binary protocol on GitHub</a></p>
</blockquote>

<h2 id="redis-scaleout">Redis scaleout</h2>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/redis-scaleout" target="_blank">find the Redis scaleout sample on GitHub</a></p>
</blockquote>

<p>For each connected client, SignalR will keep its connection ID in memory - this means that if we ever need to scale our app to multiple instances, sending a message to all connected clients will simply not work anymore, since each instance will hold only a portion of all connected clients.</p>

<p>For these situations, we will use a Redis cache and SignalR will automatically pass messages between instances. Essentially, we only need to add the reference to Redis, and the SignalR.Redis package: <code>Microsoft.AspNetCore.SignalR.Redis</code></p>

<pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    services.AddSignalR()
        .AddRedis(options =&gt; options.Factory = writer =&gt;
        {
            return ConnectionMultiplexer.Connect(&quot;localhost&quot;, writer);
        });
}
</code></pre>

<p>Now all you need is a Redis instance and you&rsquo;re set - hint: you can start a Redis Docker container within a couple of seconds with <code>docker run -p 6379:6379 --name redis  redis</code></p>

<p>Now if we start two instances of the same web application, simulating how we would normally scale the app (here we will have two different port, but normally you would have a load balancer in front of your application): <code>ASPNETCORE_URLS=&quot;http://*:5000&quot; dotnet run</code> and <code>ASPNETCORE_URLS=&quot;http://*:5001&quot; dotnet run</code>, then go to a browser:</p>

<p><img src="/img/article-photos/signalr/gif5.gif" alt="" /></p>

<blockquote>
<p>You can <a href="https://github.com/radu-matei/signalr-samples/tree/master/redis-scaleout" target="_blank">find the Redis scaleout sample on GitHub</a></p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<p>In this example I tried to exemplify most common scenarios when using SignalR - if there is a scenario you would like to see in more detail, please let me know in the comments below!</p>

<h2 id="feedback">Feedback</h2>

<p>Thanks for reading, feedback si welcome as always - you can use the comments below, or send me an email!</p>

    </div>
        

        
    <footer>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/aspnet-core'>aspnet-core</a></li>
    
        <li><a href='/categories/signalr'>signalr</a></li>
    
</ul>

    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="https://radu-matei.com/blog/k8s-appsvc/"
                class="button big previous">Best of Both worlds: Azure App Service and Kubernetes</a></li>
    

    
        <li><a href="https://radu-matei.com/blog/aci-update/"
                class="button big next">Update Azure Container Instances with Docker Hub webhooks</a></li>
    
</ul>


<article class="post">
    <div id="disqus_thread"></div>


<script type="text/javascript">
    var disqus_shortname = 'radu-matei';
    var disqus_identifier = "https://radu-matei.com/blog/signalr-core/";
    var disqus_title = "Getting started with SignalR Alpha 2";
    var disqus_url = "Getting started with SignalR Alpha 2";

    var disqus_config = function () {
        this.page.url = "https://radu-matei.com/blog/signalr-core/";  
        this.page.identifier = "https://radu-matei.com/blog/signalr-core/"; 
    };

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>
    </div>
         
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <img src="/img/main/profile.jpg" class="intro-circle" width="150" alt="Radu" />
                
            
            
                <header>
                   <a href="/"> <h2>Radu M</h2></a>
                    <p>Kubernetes, containers and cloud native open-source developer tools. Debugging distributed systems. Software Engineer @Microsoft @Azure. Opinions are my own.</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/radu-matei" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/iamradum" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>































<li><a href="//twitter.com/matei_radu" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:radu@radu-matei.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://radu-matei.com/blog/filter-k8s-logs/">Filter secrets from Kubernetes logs</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2018-08-20'>
                                    August 20, 2018</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://radu-matei.com/blog/state-of-debugging-microservices-on-k8s/">The state of debugging microservices on Kubernetes</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2018-05-05'>
                                    May 5, 2018</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://radu-matei.com/blog/debug-helm-tiller/">Debug Helm and Tiller using VS Code and Draft</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2018-04-29'>
                                    April 29, 2018</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://radu-matei.com/blog/real-world-draft/">Using Draft to develop front-end &#43; back-end applications. Experimenting with Draft, VS Code and remote debugging.</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2018-04-10'>
                                    April 10, 2018</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://radu-matei.com/blog/kube-toolkit/">kube-toolkit: Toolkit for creating gRPC-based CLI tools for Kubernetes, written in Go</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-12-18'>
                                    December 18, 2017</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /blog/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/aspnet-core/">aspnet-core</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/kubernetes/">kubernetes</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/azure/">azure</a>
                                <span style="float:right;">7</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/docker/">docker</a>
                                <span style="float:right;">4</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/signalr/">signalr</a>
                                <span style="float:right;">4</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/dependency-injection/">dependency-injection</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/dotnet-core/">dotnet-core</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/draft/">draft</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/golang/">golang</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/helm/">helm</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/vscode/">vscode</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/websockets/">websockets</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/grpc/">grpc</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/iot/">iot</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/jenkins/">jenkins</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/windows-containers/">windows-containers</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                
                    
<li><a href="//github.com/radu-matei" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/iamradum" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>































<li><a href="//twitter.com/matei_radu" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:radu@radu-matei.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>

            <p class="copyright">&copy; Radu Matei&#39;s Blog. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            

            
    </body>
</html>

