<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>Debug Helm and Tiller using VS Code and Draft</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.57.2" />
        


        
            <meta name="author" content="Radu Matei">
        
        
            
                <meta name="description" content="Radu M - Open source, #Kubernetes, cloud native, developer tools for distributed systems. Software Engineer @Microsoft @Azure. Opinions are my own.">
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Debug Helm and Tiller using VS Code and Draft"/>
<meta name="twitter:description" content="Introduction Debugging the Helm CLI Debugging Tiller  Building the Tiller binary for debugging Creating the Docker image, pushing it to a registry The Helm template for our deployment Putting it all together. Start debugging with VS Code  Conclusion  Introduction In today&rsquo;s article we will explore how to take a real-world application and start developing, debugging and deploying it to a Kubernetes cluster and how to use a couple of open-source tools to make our lives easier in the process."/>
<meta name="twitter:site" content="@matei_radu"/>

        <meta property="og:title" content="Debug Helm and Tiller using VS Code and Draft" />
<meta property="og:description" content="Introduction Debugging the Helm CLI Debugging Tiller  Building the Tiller binary for debugging Creating the Docker image, pushing it to a registry The Helm template for our deployment Putting it all together. Start debugging with VS Code  Conclusion  Introduction In today&rsquo;s article we will explore how to take a real-world application and start developing, debugging and deploying it to a Kubernetes cluster and how to use a couple of open-source tools to make our lives easier in the process." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radu-matei.com/blog/debug-helm-tiller/" />
<meta property="article:published_time" content="2018-04-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-04-29T00:00:00+00:00" />

        <meta itemprop="name" content="Debug Helm and Tiller using VS Code and Draft">
<meta itemprop="description" content="Introduction Debugging the Helm CLI Debugging Tiller  Building the Tiller binary for debugging Creating the Docker image, pushing it to a registry The Helm template for our deployment Putting it all together. Start debugging with VS Code  Conclusion  Introduction In today&rsquo;s article we will explore how to take a real-world application and start developing, debugging and deploying it to a Kubernetes cluster and how to use a couple of open-source tools to make our lives easier in the process.">


<meta itemprop="datePublished" content="2018-04-29T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-04-29T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1911">



<meta itemprop="keywords" content="" />

        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-81142224-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    </head>
    <body>

        
        <div id="wrapper">



<header id="header">
    
    <h2><a href="/">Radu M</i></a></h2>
    

    <nav class="links">
        <ul>
            
            
            
            <li>
                <a href="/blog" >
                    
                    <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                </a>
            </li>
            
            
            
            <li>
                <a href="/about" >
                    
                    <i class="fa fa-smile-o">&nbsp;</i>About
                </a>
            </li>
            
            
            
            <li>
                <a href="/speaking" >
                    
                    <i class="fa fa-comments-o">&nbsp;</i>Speaking
                </a>
            </li>
            
            
            
            <li>
                <a href="/contact" >
                    
                    <i class="fa fa-envelope-o">&nbsp;</i>Contact
                </a>
            </li>
            
            
            
            <li>
                <a href="https://github.com/radu-matei"  target="_blank" >
                    
                    <i class="fa fa-github">&nbsp;</i>Open Source
                </a>
            </li>
            
            
            
            <li>
                <a href="https://twitter.com/matei_radu"  target="_blank" >
                    
                    <i class="fa fa-twitter">&nbsp;</i>Tweets
                </a>
            </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://radu-matei.com">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
    <section>
        <form class="search" method="get" action="//google.com/search">
            <input type="text" name="q" placeholder="Search" />
            <input type="hidden" name="q" value="site:https://radu-matei.com">
        </form>
    </section>

    
    <section>
        <ul class="links">
            
            
            
            <li>
                <a href="/blog" >
                    <h3>
                        
                        <i class="fa fa-newspaper-o">&nbsp;</i>
                        
                        Blog
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="/about" >
                    <h3>
                        
                        <i class="fa fa-smile-o">&nbsp;</i>
                        
                        About
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="/speaking" >
                    <h3>
                        
                        <i class="fa fa-comments-o">&nbsp;</i>
                        
                        Speaking
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="/contact" >
                    <h3>
                        
                        <i class="fa fa-envelope-o">&nbsp;</i>
                        
                        Contact
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="https://github.com/radu-matei"  target="_blank" >
                    <h3>
                        
                        <i class="fa fa-github">&nbsp;</i>
                        
                        Open Source
                    </h3>
                </a>
            </li>
            
            
            
            <li>
                <a href="https://twitter.com/matei_radu"  target="_blank" >
                    <h3>
                        
                        <i class="fa fa-twitter">&nbsp;</i>
                        
                        Tweets
                    </h3>
                </a>
            </li>
            
        </ul>
    </section>

    
    <section>
        <ul class="links">
            <header>
                <h3>Recent Posts</h3>
            </header>
            
            
            

            
            <li>
                <a href="https://radu-matei.com/blog/building-github-actions/">
                    <p>Building Reusable GitHub Actions in TypeScript, using the official toolkit</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/kubernetes-e2e-github-actions/">
                    <p>Running Kubernetes end-to-end tests with Kind and GitHub Actions</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/kubernetes-e2e-kind-brigade/">
                    <p>Running end-to-end tests on your Kubernetes cluster with Kind and Brigade</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/helm-wasm/">
                    <p>Rendering Helm templates in the browser, with Web Assembly</p>
                </a>
            </li>
            
            <li>
                <a href="https://radu-matei.com/blog/kubernetes-controller-csharp/">
                    <p>Writing controllers for Kubernetes CRDs with C#</p>
                </a>
            </li>
            
        </ul>
    </section>

    
    
</section>
<section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&text=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft&via=matei_radu" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&title=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&title=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&title=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Radu%20Matei&body=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>


<div id="main">
    
    
    <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="https://radu-matei.com/blog/debug-helm-tiller/">Debug Helm and Tiller using VS Code and Draft</a></h1>
            
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2018-04-29'>
            April 29, 2018</time>
        <span class="author">Radu Matei</span>
        
            <p>9 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&text=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft&via=matei_radu" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&title=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&title=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f&title=Debug%20Helm%20and%20Tiller%20using%20VS%20Code%20and%20Draft" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Radu%20Matei&body=https%3a%2f%2fradu-matei.com%2fblog%2fdebug-helm-tiller%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    
    

    
        
        




    


        

        <a href="https://radu-matei.com/blog/debug-helm-tiller/" class="image featured">
            <img src="/img/article-photos/debug-helm-tiller//helm_logo_transparent.png" alt="" />
        </a>
    


    <div id="content">
        

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#debugging-the-helm-cli">Debugging the Helm CLI</a></li>
<li><a href="#debugging-tiller">Debugging Tiller</a>

<ul>
<li><a href="#building-the-tiller-binary-for-debugging">Building the Tiller binary for debugging</a></li>
<li><a href="#creating-the-docker-image-pushing-it-to-a-registry">Creating the Docker image, pushing it to a registry</a></li>
<li><a href="#the-helm-template-for-our-deployment">The Helm template for our deployment</a></li>
<li><a href="#putting-it-all-together-start-debugging-with-vs-code">Putting it all together. Start debugging with VS Code</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>In today&rsquo;s article we will explore how to take a real-world application and start developing, debugging and deploying it to a Kubernetes cluster and how to use a couple of open-source tools to make our lives easier in the process. Specifically, we will use <a href="https://github.com/kubernetes/helm" target="_blank">Helm, the package manager for Kubernetes</a>, the newly released <a href="https://github.com/azure/vscode-kubernetes-tools" target="_blank">Kubernetes extension for VS Code</a> and <a href="https://github.com/azure/draft" target="_blank">Draft</a> to develop, debug and deploy is Helm itself.</p>

<blockquote>
<p><a href="https://github.com/kubernetes/helm" target="_blank">Helm</a> helps you manage Kubernetes applications — Helm Charts help you define, install, and upgrade even the most complex Kubernetes application.
Charts are easy to create, version, share, and publish — so start using Helm and stop the copy-and-paste madness.
The latest version of Helm is maintained by the CNCF - in collaboration with Microsoft, Google, Bitnami and the Helm contributor community.
More about Helm in <a href="https://docs.helm.sh" target="_blank">the official documentation</a>.</p>

<p><a href="https://github.com/azure/draft" target="_blank">Draft</a> is an open-source tool that makes it easy to develop container-based applications and deploy them to Kubernetes clusters without knowing much about Docker and Kubernetes &ndash; Using tools like Draft lets you and your teams focus on building the application rather than on configuring clusters and writing deployment manifests.
 To get started with Draft you can <a href="https://github.com/Azure/draft/blob/master/docs/getting-started.md" target="_blank">follow the official Draft documentation</a> or watch an <a href="https://www.youtube.com/watch?v=DvaT3H8Wyf8" target="_blank">introduction to Draft from Azure Friday</a>.</p>
</blockquote>

<p>In a nutshell, Draft performs the following steps automatically for each iteration of your application:</p>

<ul>
<li>builds a container image for your app</li>
<li>pushes the container image to a registry</li>
<li>pushes the application to any Kubernetes cluster using a Helm chart</li>
</ul>

<p>We will use Draft (which uses Helm, but more on that later!) to develop, debug and deploy Helm itself. Here&rsquo;s what we&rsquo;re going to achieve:</p>

<ul>
<li>build and debug the Helm CLI using VS Code, the <a href="https://github.com/Microsoft/vscode-go" target="_blank">Golang extension for VS Code</a> and <a href="https://github.com/derekparker/delve" target="_blank">Delve, the Golang debugger</a></li>
<li>build, deploy and debug Helm&rsquo;s server-side component, Tiller, using the <a href="https://github.com/azure/vscode-kubernetes-tools" target="_blank">VS Code Kubernetes extension</a> and <a href="https://github.com/azure/draft" target="_blank">Draft</a></li>
</ul>

<p>To follow along this article, you can use <a href="https://github.com/radu-matei/helm/tree/debugging-draft" target="_blank">my branch of Helm</a> which contains all the assets necessary assets for debugging:</p>

<pre><code class="language-shell">$ git clone -b debugging-draft https://github.com/radu-matei/helm
</code></pre>

<p>Before moving to actually debugging, it is worth mentioning that Helm has two components - a client-side CLI, that runs locally on the machine and a server-side component, Tiller, which is deployed in your cluster. We will debug both components.</p>

<h1 id="debugging-the-helm-cli">Debugging the Helm CLI</h1>

<p>Debugging the Helm CLI is as simple as debugging any Golang project when using the Golang extension for VS Code and Delve - add a launch configuration and start debugging. The only thing to note here is that we can either build our binary for every change in our code, or attach to a pre-built binary - below and in the repo you&rsquo;ll find both configurations:</p>

<p>This configuration builds Helm from <code>cmd/helm</code> and attaches the debugger:</p>

<pre><code class="language-json">{
    &quot;name&quot;: &quot;Build and Debug Helm CLI&quot;,
    &quot;type&quot;: &quot;go&quot;,
    &quot;request&quot;: &quot;launch&quot;,
    &quot;mode&quot;: &quot;debug&quot;,
    &quot;program&quot;: &quot;${workspaceFolder}/cmd/helm/&quot;,
    &quot;args&quot;: [
        &quot;version&quot;
    ]
}
</code></pre>

<p>This configuration expects an existing binary in <code>bin/helm</code>, will launch it and attach the debugger:</p>

<pre><code class="language-json">{
    &quot;name&quot;: &quot;Debug Helm CLI&quot;,
    &quot;type&quot;: &quot;go&quot;,
    &quot;request&quot;: &quot;launch&quot;,
    &quot;mode&quot;: &quot;exec&quot;,
    &quot;program&quot;: &quot;${workspaceFolder}/bin/helm&quot;,
    &quot;args&quot;: [
        &quot;version&quot;
    ]
}
</code></pre>

<p>In both cases, the default command executed will be <code>helm version</code> - note that you can customize the command and arguments passed to your binary, and you can set breakpoints in your Helm CLI&rsquo;s code. If you select the desired configuration and start debugging (F5), the execution of <code>helm version</code> will start. If you setup breakpoints in VS Code, the execution will be stopped and you can step in, out and over method executions or evaluate expressions and variable values:</p>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/qUbkGq-RygM" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<p>To change the command and arguments passed to the Helm CLI, simply add to the <code>args</code> property in the launch configuration.
Notice that we are debugging the local component of Helm - the <code>helm version</code> command is executed part locally (what we debugged) and part on the cluster:</p>

<pre><code>Client: &amp;version.Version{SemVer:&quot;v2.8+unreleased&quot;, GitCommit:&quot;&quot;, GitTreeState:&quot;&quot;}
Server: &amp;version.Version{SemVer:&quot;v2.8.2&quot;, GitCommit:&quot;a80231648a1473929271764b920a8e346f6de844&quot;, GitTreeState:&quot;clean&quot;}
</code></pre>

<p>The server version was executed in the cluster - we did not debug that call simply because we only started debugging the local component of Helm. Let&rsquo;s debug Tiller!</p>

<h1 id="debugging-tiller">Debugging Tiller</h1>

<p>To debug remote components deployed in a Kubernetes cluster you need to:</p>

<ul>
<li>build your application for debugging (include the debugging symbols)</li>
<li>create a Docker image and push it to a container registry</li>
<li>update your Kubernetes manifest or Helm chart with the correct image tag, a debugger port exposed and the correct security context so the debugger can attach to a process inside your pod (in the case of NodeJS you don&rsquo;t have to do anything; for Go you need the <code>SYS_PTRACE</code> capability)</li>
<li>wait for a pod to be running</li>
<li>forward all application and debugger ports from your pod to <code>localhost</code></li>
<li>attach the local debugger to the remote target on the <code>localhost</code> port exposed by port forwarding</li>
</ul>

<p>The entire concept of <em>debugging</em> means that most likely you will have to to this process multiple times, which can be incredibly time consuming, repetitive and annoying. This is where Draft and the VS Code Kubernetes extension come in extremely handy - Draft will automate the process of building and pushing the container image, then releasing the new version of your application, and the VS Code Kubernetes extension makes sure to attach the correct debugger after all the ports in your pod are forwarded. Let&rsquo;s see how to setup the process specifically for Tiller - we will take each step above and particularize it for the current version of Helm:</p>

<h3 id="building-the-tiller-binary-for-debugging">Building the Tiller binary for debugging</h3>

<p>The <a href="https://github.com/kubernetes/helm/blob/master/Makefile#L59" target="_blank">Helm&rsquo;s Makefile</a> contains a target called <code>docker-binary</code> which will create a Linux binary. Since that binary is intended for production use, it will omit the debugging symbols (the <code>-w</code> flag is passed, more information below).</p>

<blockquote>
<p>Pass the &lsquo;-w&rsquo; flag to the linker to omit the debug information (for example, go build -ldflags=-w prog.go). - from <a href="https://golang.org/doc/gdb" target="_blank">the Golang documentation on debugging</a></p>
</blockquote>

<p>We will not be able to use this binary for debugging, so we simply create a new Make target where we pass the desired Golang build flags:</p>

<pre><code>.PHONY: docker-debug
docker-debug: BINDIR = ./rootfs
docker-debug:
	GOOS=linux GOARCH=amd64 $(GO) build -o $(BINDIR)/tiller k8s.io/helm/cmd/tiller
</code></pre>

<blockquote>
<p>For simplicity I also removed some other flags from building the binary - to be as close as possible to production, pass the desired flags, while also making sure you&rsquo;re not breaking the Delve debugger.</p>
</blockquote>

<p>Before we get to building the image and push it to a registry, we need a way to <code>make docker-debug</code>. Draft has a feature called <a href="https://github.com/Azure/draft/blob/master/docs/reference/dep-008.md" target="_blank">Draft tasks</a> which we will use to build the Tiller binary -  add a <code>.draft-tasks.toml</code> file which contains a <code>pre-up</code> task:</p>

<pre><code>[pre-up]
    build-tiller = &quot;make docker-debug&quot;
</code></pre>

<blockquote>
<p>Note that if you don&rsquo;t want to create a new binary every time you attach the debugger you can comment the step above and simply <code>make docker-debug</code> when you want a new Tiller binary.</p>
</blockquote>

<h3 id="creating-the-docker-image-pushing-it-to-a-registry">Creating the Docker image, pushing it to a registry</h3>

<p>In the repo you can find <code>Dockerfile.tiller.debug</code>, which we will use to build the container image:</p>

<pre><code>FROM radumatei/golang-delve

COPY rootfs/tiller .
COPY rootfs/start.sh .

RUN chmod +x start.sh
CMD ./start.sh
</code></pre>

<ul>
<li>we need a base image that either contains the Golang debugger, Delve, or install it - for simplicity, we&rsquo;re using a pre-built image with Delve, but you can create your own base image for debugging  (<strong>and you should!</strong> - you don&rsquo;t want to trust random images from the Internet)</li>
<li>we copy the Tiller binary we built before</li>

<li><p>we also copy a shell script and use it to start the container - this script will start Tiller and attach the Delve debugger to the Tiller process, creating a headless Delve server and exposing it on port 2345:</p>

<pre><code>./tiller &amp; 
dlv attach $(pgrep -x tiller | head -n 1) tiller --headless --listen=0.0.0.0:2345 --log=true
</code></pre></li>
</ul>

<p>Now we need to configure a couple of things for Draft, in <code>draft.toml</code>:</p>

<pre><code>[environments]
  [environments.development]
    name = &quot;tiller-debug&quot;
    namespace = &quot;default&quot;
    override-ports = [&quot;2345:2345&quot;, &quot;44134:44134&quot;, &quot;44135:44135&quot;]
    dockerfile = &quot;Dockerfile.tiller.debug&quot;
    chart = &quot;tiller&quot;
</code></pre>

<ul>
<li>the name and namespace of our application</li>
<li>how to expose the pod&rsquo;s ports locally on <code>localhost</code></li>
<li>the Dockerfile and chart to use</li>
</ul>

<h3 id="the-helm-template-for-our-deployment">The Helm template for our deployment</h3>

<p>The only missing part is the actual Kubernetes configuration for our application - here are the most important things to note in the deployment template (not the complete file!):</p>

<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
spec:
  template:
    spec:
      containers:
      - name: {{ .Chart.Name }}
        securityContext:
          capabilities:
            add:
              - SYS_PTRACE
        image: &quot;{{ .Values.image.repository }}:{{ .Values.image.tag }}&quot;
        env:
        - name: TILLER_NAMESPACE
          value: &quot;default&quot;
        - name: TILLER_HISTORY_MAX
          value: &quot;0&quot;
        ports:
        - containerPort: {{ .Values.ports.tiller }}
        - containerPort: {{ .Values.ports.http }}
        - containerPort: {{ .Values.ports.debug }}
</code></pre>

<blockquote>
<p>Note that I omitted the metadata, labels and annotations for this deployment to keep only the relevant fields - use the complete file in the repo for your template!</p>

<p>The ports described here are the ones used by our application, plus the debugger port for Delve, and they can be found in <code>values.yaml</code></p>
</blockquote>

<p>The thing to note for the deployment is the <code>SYS_PTRACE</code> capability - this is because <code>dlv attach</code> needs to <code>ptrace</code> the target process, and this is disabled by the default Kubernetes security context.</p>

<h3 id="putting-it-all-together-start-debugging-with-vs-code">Putting it all together. Start debugging with VS Code</h3>

<p>At this point you need the Kubernetes extension for VS Code and you need to add a <code>draft</code> debug configuration, together with a Golang remote debug configuration. This will execute <code>draft up</code>, <code>draft connect</code> to expose the ports to <code>localhost</code>, then will attach the debug configuration you specified:</p>

<pre><code class="language-json">        {
            &quot;type&quot;: &quot;draft&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;name&quot;: &quot;Draft Debug Tiller&quot;,
            &quot;original-debug&quot;: {
                &quot;name&quot;: &quot;Kubernetes remote debugging&quot;,
                &quot;type&quot;: &quot;go&quot;,
                &quot;request&quot;: &quot;launch&quot;,
                &quot;mode&quot;: &quot;remote&quot;,
                &quot;remotePath&quot;: &quot;/go/src/app&quot;,
                &quot;port&quot;: 2345,
                &quot;host&quot;: &quot;127.0.0.1&quot;,
                &quot;program&quot;: &quot;&lt;YOUR_GOPATH&gt;src/k8s.io/helm/cmd/tiller&quot;,
                &quot;args&quot;: []
            }
        }
</code></pre>

<blockquote>
<p>Remember to correctly add your <code>$GOPATH</code> in the <code>program</code> field in the configuration - this is a currently known limitation of the extension</p>
</blockquote>

<p>The <code>original-debug</code> configuration is simply a Golang remote debug configuration instructing to attach the debugger on <code>localhost:2345</code> - essentially, the extension orchestrates all the steps necessary to successfully debug your application.</p>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/z6mWx4C3p7I" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<p>Now as you saw in the video, we&rsquo;re attached to Tiller which is deployed in Kubernetes.</p>

<blockquote>
<p>Note that because of a current know limitation of the extension and VS Code we have to use a different window to debug the CLI - we hope to eliminate this limitation very soon, and then you will be able to use a single instance of VS Code to debug both the CLI and Tiller.</p>
</blockquote>

<p>Iterating through multiple versions of your application simply means starting the Draft debug session again in VS Code - Draft will automatically build the new image for you, push it and then upgrade the deployment, and the extension will attach the remote debugger again. No more searching through the logs for errors, searching through the kubernetes resources for the name of your pods and deployments and manually starting port forwards. The VS Code Kubernetes extension will automate the entire process of deploying the new version of your application and will attach the debugger at the right time.</p>

<h1 id="conclusion">Conclusion</h1>

<p>In this article we saw how to debug a real-world application deployed on Kubernetes, Helm, and we saw how VS Code and Draft can make our lives much easier when developing, deploying and debugging applications to Kubernetes. Let me know in the comments below your thoughts, and as always, thanks for reading :)</p>

    </div>
        

        
    <footer>
        <ul class="stats">
    
    

    
    
    <li>
        
        
        

        
        Categories
        
        
    </li>
    
    

    
    
    <li><a href='/categories/kubernetes'>kubernetes</a></li>
    
    <li><a href='/categories/draft'>draft</a></li>
    
    <li><a href='/categories/helm'>helm</a></li>
    
    <li><a href='/categories/vscode'>vscode</a></li>
    
</ul>
    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="https://radu-matei.com/blog/real-world-draft/"
                class="button big previous">Using Draft to develop front-end &#43; back-end applications. Experimenting with Draft, VS Code and remote debugging.</a></li>
    

    
        <li><a href="https://radu-matei.com/blog/state-of-debugging-microservices-on-k8s/"
                class="button big next">The state of debugging microservices on Kubernetes</a></li>
    
</ul>


<article class="post">
    <div id="disqus_thread"></div>


<script type="text/javascript">
    var disqus_shortname = 'radu-matei';
    var disqus_identifier = "https://radu-matei.com/blog/debug-helm-tiller/";
    var disqus_title = "Debug Helm and Tiller using VS Code and Draft";
    var disqus_url = "Debug Helm and Tiller using VS Code and Draft";

    var disqus_config = function () {
        this.page.url = "https://radu-matei.com/blog/debug-helm-tiller/";  
        this.page.identifier = "https://radu-matei.com/blog/debug-helm-tiller/"; 
    };

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>
</div>


<section id="sidebar">

    
    <section id="intro">
        
        
        
        <img src="/img/main/profile.jpg" class="intro-circle" width="150" alt="Radu" />
        
        
        
        <header>
            <a href="/">
                <h2>Radu M</h2>
            </a>
            <p>Open source, Kubernetes, cloud native, developer tools for distributed systems. Software Engineer at Microsoft Azure. Opinions are my own.</p>
        </header>
        
        <ul class="icons">
            
            
            
<li><a href="//github.com/radu-matei" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/iamradum" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>

















<li><a href="//linkedin.com/in/mateiradu" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>















<li><a href="//twitter.com/matei_radu" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:root@radu.sh" title="Email" class="fa fa-envelope"></a></li>


            
        </ul>
    </section>

    
    <section id="recent-posts">
        <ul class="posts">
            <header>
                <h3>Recent Posts</h3>
            </header>
            
            
            

            
            
            

            
            <li>
                <article>
                    <header>
                        <h3><a href="https://radu-matei.com/blog/building-github-actions/">Building Reusable GitHub Actions in TypeScript, using the official toolkit</a></h3>
                        
                        
                        
                        <time class="published" datetime='2019-08-23'>
                            August 23, 2019</time>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <h3><a href="https://radu-matei.com/blog/kubernetes-e2e-github-actions/">Running Kubernetes end-to-end tests with Kind and GitHub Actions</a></h3>
                        
                        
                        
                        <time class="published" datetime='2019-08-21'>
                            August 21, 2019</time>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <h3><a href="https://radu-matei.com/blog/kubernetes-e2e-kind-brigade/">Running end-to-end tests on your Kubernetes cluster with Kind and Brigade</a></h3>
                        
                        
                        
                        <time class="published" datetime='2019-08-10'>
                            August 10, 2019</time>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <h3><a href="https://radu-matei.com/blog/helm-wasm/">Rendering Helm templates in the browser, with Web Assembly</a></h3>
                        
                        
                        
                        <time class="published" datetime='2019-05-11'>
                            May 11, 2019</time>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <h3><a href="https://radu-matei.com/blog/kubernetes-controller-csharp/">Writing controllers for Kubernetes CRDs with C#</a></h3>
                        
                        
                        
                        <time class="published" datetime='2019-05-06'>
                            May 6, 2019</time>
                    </header>
                </article>
            </li>
            

            
            <li>
                <ul class="actions">
                    <li><a href= /blog/ 
                            class="button">View more posts</a></li>
                </ul>
            </li>
            
        </ul>
    </section>

    
    
    
    
    

    
    

    
    <section id="footer">
        <ul class="icons">
            
            
            
<li><a href="//github.com/radu-matei" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/iamradum" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>

















<li><a href="//linkedin.com/in/mateiradu" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>















<li><a href="//twitter.com/matei_radu" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:root@radu.sh" title="Email" class="fa fa-envelope"></a></li>


            
        </ul>

        <p class="copyright">&copy; Radu Matei&#39;s Blog. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
    </section>

</section>
            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            

            
    </body>
</html>
